<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>é¦¬ä¸Šéé—œ - 2026æ–°å¹´éŠæˆ²</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #1a1a2e;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            touch-action: none; /* ç¦ç”¨é»˜è®¤è§¦æ‘¸è¡Œä¸º */
        }
        
        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #gameCanvas {
            border: 4px solid #ffd700;
            border-radius: 8px;
            background-color: #000;
            display: block;
            max-width: 100%;
            max-height: 100%;
            touch-action: none;
        }
        
        .game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            color: #ffd700;
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            z-index: 10;
        }
        
        .game-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .btn {
            background-color: #ff4500;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            margin-top: 20px;
            min-width: 150px;
        }
        
        .btn:hover {
            background-color: #ff6347;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .game-title {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: #ffd700;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 5;
        }
        
        .ui-container {
            position: absolute;
            top: 60px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 5;
        }
        
        .ui-item {
            background-color: rgba(0, 0, 0, 0.7);
            color: #ffd700;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
        }
        
        /* æ©«å±æ¨¡å¼æ¨£å¼ - å„ªåŒ–ç§»å‹•ç«¯é«”é©— */
        @media screen and (orientation: landscape) and (max-width: 900px) {
            .game-title {
                font-size: 18px;
                top: 5px;
            }
            
            .ui-container {
                top: 30px;
            }
            
            .ui-item {
                font-size: 14px;
                padding: 6px 10px;
            }
            
            /* æ©«å±æ™‚ç¸®å°canvasé«˜åº¦ï¼Œçµ¦æŒ‰éˆ•ç•™å‡ºæ›´å¤šç©ºé–“ */
            #gameCanvas {
                max-height: calc(100vh - 80px);
            }
            
            /* èª¿æ•´è§¸æ‘¸æŒ‰éˆ•å¤§å°å’Œä½ç½® */
            .touch-controls {
                bottom: 10px;
                padding: 0 20px;
            }
            
            .touch-btn {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .direction-controls {
                gap: 15px;
            }
        }
        
        /* è±å±æ¨¡å¼æ¨£å¼ - å„ªåŒ–ç§»å‹•ç«¯é«”é©— */
        @media screen and (orientation: portrait) {
            .game-container {
                justify-content: flex-start;
                padding-top: 50px;
            }
            
            #gameCanvas {
                width: 100%;
                height: auto;
                max-height: calc(100% - 150px);
            }
            
            .game-title {
                font-size: 26px;
                top: 10px;
            }
            
            .ui-container {
                top: 45px;
                flex-direction: column;
                gap: 8px;
            }
            
            .ui-item {
                font-size: 17px;
                padding: 8px 12px;
                text-align: center;
            }
            
            /* è±å±æ™‚èª¿æ•´æŒ‰éˆ•ä½ç½® */
            .touch-controls {
                bottom: 15px;
            }
            
            .touch-btn {
                width: 75px;
                height: 75px;
                font-size: 28px;
            }
        }
        
        /* å°å±å¹•è¨­å‚™é¡å¤–å„ªåŒ– */
        @media screen and (max-width: 375px) {
            .touch-btn {
                width: 65px;
                height: 65px;
                font-size: 24px;
            }
            
            .direction-controls {
                gap: 10px;
            }
            
            .game-title {
                font-size: 22px;
            }
        }
        
        /* æ“ä½œæç¤º */
        .control-tips {
            position: absolute;
            bottom: 100px;
            left: 0;
            right: 0;
            text-align: center;
            color: #ffd700;
            font-size: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 5;
        }
        
        /* è§¦æ‘¸æ§åˆ¶æŒ‰é’® - å„ªåŒ–ç§»å‹•ç«¯é«”é©— */
        .touch-controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 15;
            opacity: 0.95;
        }
        
        .touch-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff4500 0%, #8b0000 100%);
            border: 4px solid #ffd700;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            color: white;
            user-select: none;
            touch-action: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            /* å„ªåŒ–è§¸æ‘¸åé¥‹ */
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }
        
        .touch-btn::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            border-radius: 50%;
            z-index: -1;
            animation: rotate 3s linear infinite;
        }
        
        .touch-btn.jump {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
            color: #8b0000;
        }
        
        .touch-btn.jump::before {
            background: linear-gradient(45deg, #ff4500, #ff6347, #ff4500);
        }
        
        .touch-btn:active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #ff6347 0%, #8b0000 100%);
        }
        
        .touch-btn.jump:active {
            background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
        }
        
        /* æ–¹å‘æŒ‰é’®å®¹å™¨ */
        .direction-controls {
            display: flex;
            gap: 15px;
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ–°å¹´è£…é¥° */
        .touch-btn::after {
            content: 'ğŸ§§';
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 16px;
            z-index: 1;
        }
        
        .touch-btn.jump::after {
            content: 'ğŸ';
        }
        
        /* ç§»åŠ¨è®¾å¤‡éšè—é”®ç›˜æç¤º */
        @media (max-width: 768px) {
            .keyboard-tips {
                display: none;
            }
        }
        
        /* æ¡Œé¢è®¾å¤‡éšè—è§¦æ‘¸æŒ‰é’® */
        @media (min-width: 769px) {
            .touch-controls {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">é¦¬ä¸Šéé—œ</h1>
        
        <div class="ui-container">
            <div class="ui-item" id="scoreDisplay">åˆ†æ•¸: 0</div>
            <div class="ui-item" id="livesDisplay">ç”Ÿå‘½: 3</div>
        </div>
        
        <canvas id="gameCanvas" width="800" height="1200"></canvas>
        
        <div id="startScreen" class="game-overlay visible">
            <h2 style="font-size: 40px; font-weight: bold; margin-bottom: 20px;">é¦¬ä¸Šéé—œ</h2>
            <p style="font-size: 20px; margin-bottom: 30px;">æ“ä½œè²¡ç¥èˆ‡é¦¬ï¼Œè·³ä¸Šå¹³å°æ”¶é›†ç¥ç¦ï¼</p>
            <p class="keyboard-tips" style="font-size: 16px; margin-bottom: 10px;">â† â†’ ç§»å‹• | ç©ºç™½éµ/â†‘ è·³èº</p>
            <p style="font-size: 16px; margin-bottom: 10px;">ç§»å‹•è¨­å‚™ï¼šä½¿ç”¨è¢å¹•æŒ‰éˆ•æ§åˆ¶</p>
            <button id="startBtn" class="btn">é–‹å§‹éŠæˆ²</button>
        </div>
        
        <div id="gameOverScreen" class="game-overlay">
            <h2 style="font-size: 40px; font-weight: bold; margin-bottom: 20px;">éŠæˆ²çµæŸ</h2>
            <p id="finalScore" style="font-size: 24px; margin-bottom: 30px;">åˆ†æ•¸ï¼š0</p>
            <button id="restartBtn" class="btn">å†ç©ä¸€æ¬¡</button>
        </div>
        
        <div id="winScreen" class="game-overlay">
            <h2 style="font-size: 45px; font-weight: bold; margin-bottom: 20px;">æ­å–œéé—œ!</h2>
            <p style="font-size: 28px; margin-bottom: 30px;">FOTOCINEç¥ä½ 2026 é¦¬åˆ°åŠŸæˆ!</p>
            <button id="playAgainBtn" class="btn">å†ç©ä¸€æ¬¡</button>
        </div>
        
        <div class="control-tips">
            <span class="keyboard-tips">â† â†’ ç§»å‹• | ç©ºç™½éµ/â†‘ è·³èº</span>
            <span class="touch-tips">ä½¿ç”¨è¢å¹•æŒ‰éˆ•æ§åˆ¶</span>
        </div>
        
        <!-- è§¦æ‘¸æ§åˆ¶æŒ‰é’® -->
        <div class="touch-controls">
            <div class="direction-controls">
                <div class="touch-btn" id="touchLeft">â†</div>
                <div class="touch-btn" id="touchRight">â†’</div>
            </div>
            <div class="touch-btn jump" id="touchJump">â†‘</div>
        </div>
    </div>

    <script>
        // éŠæˆ²åˆå§‹åŒ–
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // èª¿æ•´canvaså¤§å°ä»¥é©æ‡‰è¢å¹• - å„ªåŒ–ç§»å‹•ç«¯
        function resizeCanvas() {
            const container = canvas.parentElement;
            const maxWidth = container.clientWidth;
            const maxHeight = container.clientHeight;
            
            // è¨ˆç®—æœ€ä½³ç¸®æ”¾æ¯”ä¾‹ï¼Œè€ƒæ…®ç§»å‹•ç«¯è¢å¹•
            const scaleX = maxWidth / canvas.width;
            const scaleY = maxHeight / canvas.height;
            const scale = Math.min(scaleX, scaleY, 1); // ä¸è¶…é1å€
            
            canvas.style.width = `${canvas.width * scale}px`;
            canvas.style.height = `${canvas.height * scale}px`;
        }
        
        window.addEventListener('resize', resizeCanvas);
        // ç§»å‹•ç«¯åŠ è¼‰æ™‚å»¶é²èª¿æ•´ï¼Œç¢ºä¿å°ºå¯¸æ­£ç¢º
        setTimeout(resizeCanvas, 100);
        
        // éŠæˆ²è³‡æº
        const gameAssets = {
            player: null,
            background: null,
            platform: null,
            loaded: false
        };
        
        // åŠ è¼‰ç©å®¶åœ–åƒ
        function loadPlayerImage() {
            const playerImage = new Image();
            playerImage.src = 'https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/95ac9078fb4a4d398386db71fc891044.png~tplv-a9rns2rl98-24:720:720.png?rcl=2025123011295320E601E2BCDB27F1FA59&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1767670193&x-signature=SISmzfzeh3NxadKNereDNq3%2B1wI%3D';
            return playerImage;
        }
        
        // åŠ è¼‰èƒŒæ™¯åœ–åƒ
        function loadBackgroundImage() {
            const backgroundImage = new Image();
            backgroundImage.src = 'https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/3efe0e85e3fb46a9815618cef12ab61b~tplv-a9rns2rl98-image.image?rcl=20251230112402D0D1E800555509EEAF89&rk3s=8e244e95&rrcfp=f06b921b&x-expires=1769657067&x-signature=r16mFPYgC3FY4rOneIIV4xGdlfU%3D';
            return backgroundImage;
        }
        
        // å‰µå»ºå¹³å°åœ–åƒ - ä¿®æ”¹ç‚ºé‡‘è‰²ç³»
        function createPlatformImage() {
            const platformCanvas = document.createElement('canvas');
            platformCanvas.width = 120;
            platformCanvas.height = 20;
            const platformCtx = platformCanvas.getContext('2d');
            
            // å¹³å°åº•è‰²ï¼ˆé‡‘è‰²æ¼¸è®Šæ•ˆæœï¼‰
            const gradient = platformCtx.createLinearGradient(0, 0, 0, 20);
            gradient.addColorStop(0, '#ffd700');    // äº®é‡‘è‰²
            gradient.addColorStop(0.5, '#ffc107');  // ä¸­é‡‘è‰²
            gradient.addColorStop(1, '#b8860b');    // æš—é‡‘è‰²
            platformCtx.fillStyle = gradient;
            platformCtx.fillRect(0, 0, 120, 20);
            
            // å¹³å°è£é£¾é‚Šæ¡†ï¼ˆæ›´æ·±çš„é‡‘è‰²ï¼‰
            platformCtx.lineWidth = 2;
            platformCtx.strokeStyle = '#8B7500';
            platformCtx.strokeRect(0, 0, 120, 20);
            
            // è£é£¾åœ–æ¡ˆï¼ˆé‡‘è‰²èŠ±ç´‹ï¼‰
            platformCtx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            for (let i = 0; i < 5; i++) {
                const x = 10 + i * 22;
                platformCtx.fillRect(x, 8, 10, 4);
            }
            
            return platformCanvas;
        }
        
        // åŠ è¼‰éŠæˆ²è³‡æº
        function loadGameAssets() {
            try {
                gameAssets.player = loadPlayerImage();
                gameAssets.background = loadBackgroundImage();
                gameAssets.platform = createPlatformImage();
                
                let loadedCount = 0;
                const totalAssets = 2;
                
                function onAssetLoaded() {
                    loadedCount++;
                    if (loadedCount >= totalAssets) {
                        gameAssets.loaded = true;
                        drawGame();
                    }
                }
                
                gameAssets.player.onload = onAssetLoaded;
                gameAssets.background.onload = onAssetLoaded;
                
                gameAssets.player.onerror = () => onAssetLoaded();
                gameAssets.background.onerror = () => onAssetLoaded();
                
                if (gameAssets.player.complete) onAssetLoaded();
                if (gameAssets.background.complete) onAssetLoaded();
                
            } catch (error) {
                console.error('åŠ è¼‰è³‡æºæ™‚å‡ºéŒ¯:', error);
                gameAssets.loaded = true;
            }
        }
        
        // ç¥ç¦è©åˆ—è¡¨
        const blessings = [
            'é¦¬ä¸Šç™¼è²¡', 'é¦¬ä¸Šé€²æ­¥', 'é¦¬ä¸Šå‡è·', 'é¦¬ä¸Šå¥åº·',
            'é¦¬ä¸Šå¹¸ç¦', 'é¦¬ä¸Šå¥½é‹', 'é¦¬ä¸ŠæˆåŠŸ', 'é¦¬ä¸Šå¹³å®‰',
            'é¦¬ä¸Šå¿«æ¨‚', 'é¦¬ä¸Šå‰ç¥¥', 'é¦¬ä¸Šè°æ˜', 'é¦¬ä¸Šé’æ˜¥'
        ];
        
        // éŠæˆ²ç‹€æ…‹
        const gameState = {
            started: false,
            over: false,
            won: false,
            score: 0,
            lives: 3,
            collectedBlessings: [],
            scrollY: 0,
            gameSpeed: 1
        };
        
        // ç©å®¶è¨­å®š - å„ªåŒ–ç§»å‹•ç«¯æ“æ§
        const player = {
            x: 100,
            y: 1000,
            width: 100,
            height: 100,
            speed: 5, // ç§»å‹•ç«¯ç¨å¾®æ¸›æ…¢é€Ÿåº¦ï¼Œæ›´å®¹æ˜“æ§åˆ¶
            jumpPower: 18, // é©ç•¶æ¸›å°‘è·³èºåŠ›åº¦ï¼Œæå‡æ“æ§ç²¾æº–åº¦
            velocityY: 0,
            isJumping: false,
            direction: 1
        };
        
        // æª¢æ¸¬ç§»å‹•ç«¯ï¼Œé€²ä¸€æ­¥å„ªåŒ–éŠæˆ²åƒæ•¸
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            player.speed = 4.5; // ç§»å‹•ç«¯é€²ä¸€æ­¥æ¸›æ…¢
            player.jumpPower = 17; // ç§»å‹•ç«¯è·³èºæ›´å¹³ç©©
        }
        
        // å¹³å°é…ç½®
        const platforms = [];
        const platformConfig = {
            minWidth: 100,
            maxWidth: 200,
            minGap: 80,
            maxGap: 150,
            minHeight: 30,
            maxHeight: 80,
            startY: 1000, // èµ·é»åœ¨ç•«é¢åº•éƒ¨
            endPlatformY: -1300, // çµ‚é»å¹³å°å›ºå®šä½ç½®ï¼ˆæœ€é ‚ç«¯ï¼‰
            maxPlatformHeight: -1200 // æ™®é€šå¹³å°æœ€é«˜ä½ç½®ï¼ˆçµ‚é»ä¹‹ä¸‹ï¼‰
        };
        
        // æŒ‰éµæ§åˆ¶
        const keys = {
            left: false,
            right: false,
            up: false
        };
        
        // è§¦æ‘¸æ§åˆ¶çŠ¶æ€
        const touchState = {
            left: false,
            right: false,
            jump: false
        };
        
        // åˆå§‹åŒ–å¹³å° - ç¢ºä¿çµ‚é»åœ¨æœ€é ‚ç«¯ï¼Œæ‰€æœ‰å¹³å°éƒ½å¯è¸
        function initPlatforms() {
            platforms.length = 0;
            
            // èµ·å§‹å¹³å°ï¼ˆåº•éƒ¨ï¼‰
            platforms.push({
                x: 0,
                y: platformConfig.startY,
                width: canvas.width,
                height: 20,
                blessing: '',
                collected: true
            });
            
            // ç”Ÿæˆæ™®é€šå¹³å°ï¼ˆç¢ºä¿éƒ½åœ¨çµ‚é»ä¹‹ä¸‹ï¼‰
            let currentY = platformConfig.startY;
            while (currentY > platformConfig.maxPlatformHeight) {
                const width = Math.random() * (platformConfig.maxWidth - platformConfig.minWidth) + platformConfig.minWidth;
                const gap = Math.random() * (platformConfig.maxGap - platformConfig.minGap) + platformConfig.minGap;
                const height = Math.random() * (platformConfig.maxHeight - platformConfig.minHeight) + platformConfig.minHeight;
                
                currentY -= height + gap;
                
                // ç¢ºä¿å¹³å°ä¸æœƒè¶…éæœ€é«˜é™åˆ¶
                if (currentY < platformConfig.maxPlatformHeight) {
                    break;
                }
                
                // ç¢ºä¿å¹³å°åœ¨ç•«å¸ƒç¯„åœå…§ï¼Œä¸¦ä¸”æœ‰è¶³å¤ çš„å¯¬åº¦è®“ç©å®¶è¸ä¸Š
                const x = Math.random() * (canvas.width - width - 50) + 25;
                
                // éš¨æ©Ÿé¸æ“‡ç¥ç¦è©ï¼ˆæ¯å€‹å¹³å°éƒ½æœ‰ç¥ç¦è©ï¼‰
                let availableBlessings = blessings.filter(b => !platforms.some(p => p.blessing === b));
                let blessing = '';
                if (availableBlessings.length > 0) {
                    blessing = availableBlessings[Math.floor(Math.random() * availableBlessings.length)];
                } else {
                    // å¦‚æœç¥ç¦è©ç”¨å®Œäº†ï¼Œéš¨æ©Ÿé¸ä¸€å€‹
                    blessing = blessings[Math.floor(Math.random() * blessings.length)];
                }
                
                platforms.push({
                    x,
                    y: currentY,
                    width,
                    height: 20,
                    blessing,
                    collected: false
                });
            }
            
            // çµ‚é»å¹³å°ï¼ˆå›ºå®šåœ¨æœ€é ‚ç«¯ï¼Œç¢ºä¿åœ¨æ‰€æœ‰å¹³å°ä¹‹ä¸Šï¼‰
            platforms.push({
                x: canvas.width / 2 - 100,
                y: platformConfig.endPlatformY,
                width: 200,
                height: 20,
                blessing: 'çµ‚é»',
                collected: false
            });
            
            console.log(`ç”Ÿæˆäº† ${platforms.length} å€‹å¹³å°ï¼Œçµ‚é»å¹³å°ä½ç½®: ${platformConfig.endPlatformY}`);
        }
        
        // é‡ç½®ç©å®¶ä½ç½®
        function resetPlayer() {
            player.x = 100;
            player.y = platformConfig.startY - player.height;
            player.velocityY = 0;
            player.isJumping = false;
            player.direction = 1;
            
            keys.left = false;
            keys.right = false;
            keys.up = false;
            
            touchState.left = false;
            touchState.right = false;
            touchState.jump = false;
        }
        
        // é‡ç½®éŠæˆ²
        function resetGame() {
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            gameState.started = false;
            gameState.over = false;
            gameState.won = false;
            gameState.score = 0;
            gameState.lives = 3;
            gameState.collectedBlessings = [];
            gameState.scrollY = 0;
            gameState.gameSpeed = 1;
            
            // é‡æ–°åˆå§‹åŒ–
            initPlatforms();
            resetPlayer();
            
            // éš±è—è¦†è“‹å±¤
            document.getElementById('startScreen').classList.add('visible');
            document.getElementById('gameOverScreen').classList.remove('visible');
            document.getElementById('winScreen').classList.remove('visible');
        }
        
        // æ›´æ–°ç©å®¶ä½ç½® - å„ªåŒ–ç¢°æ’æª¢æ¸¬ï¼Œç¢ºä¿æ¯å€‹å¹³å°éƒ½èƒ½è¸ä¸Šå»
        function updatePlayer() {
            if (!gameState.started || gameState.over || gameState.won) return;
            
            // é‡åŠ› - ç§»å‹•ç«¯ç¨å¾®æ¸›å°é‡åŠ›ï¼Œè·³èºæ›´èˆ’é©
            const gravity = isMobile ? 0.45 : 0.5;
            player.velocityY += gravity * gameState.gameSpeed;
            player.y += player.velocityY;
            
            // å·¦å³ç§»å‹•ï¼ˆåŒæ—¶å¤„ç†é”®ç›˜å’Œè§¦æ‘¸æ§åˆ¶ï¼‰
            if ((keys.left || touchState.left) && !(keys.right || touchState.right)) {
                player.x -= player.speed;
                player.direction = -1;
            } else if ((keys.right || touchState.right) && !(keys.left || touchState.left)) {
                player.x += player.speed;
                player.direction = 1;
            }
            
            // è·³èºï¼ˆåŒæ—¶å¤„ç†é”®ç›˜å’Œè§¦æ‘¸æ§åˆ¶ï¼‰
            if ((keys.up || touchState.jump) && !player.isJumping) {
                player.velocityY = -player.jumpPower;
                player.isJumping = true;
            }
            
            // é‚Šç•Œé™åˆ¶
            if (player.x < 0) player.x = 0;
            else if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
            
            // å¹³å°ç¢°æ’æª¢æ¸¬ - å„ªåŒ–ç‰ˆæœ¬ï¼Œæ›´å¯¬é¬†çš„åˆ¤å®šæ¢ä»¶
            let onPlatform = false;
            let closestPlatform = null;
            let closestDistance = Infinity;
            
            // ç¬¬ä¸€æ­¥ï¼šæ‰¾åˆ°ç©å®¶ä¸‹æ–¹æœ€è¿‘çš„å¹³å°
            platforms.forEach(platform => {
                const platformRect = {
                    x: platform.x,
                    y: platform.y + gameState.scrollY,
                    width: platform.width,
                    height: platform.height
                };
                
                // æª¢æŸ¥ç©å®¶æ˜¯å¦åœ¨å¹³å°ä¸Šæ–¹ï¼Œä¸¦ä¸”æ°´å¹³é‡ç–Š
                const isHorizontallyOverlapping = 
                    player.x + player.width > platformRect.x + 5 &&  // æ”¾å¯¬å·¦é‚Šåˆ¤å®š
                    player.x < platformRect.x + platformRect.width - 5; // æ”¾å¯¬å³é‚Šåˆ¤å®š
                
                // æª¢æŸ¥å¹³å°æ˜¯å¦åœ¨ç©å®¶ä¸‹æ–¹
                if (isHorizontallyOverlapping && platformRect.y > player.y + player.height - 10) {
                    const distance = platformRect.y - (player.y + player.height);
                    if (distance >= 0 && distance < closestDistance) {
                        closestDistance = distance;
                        closestPlatform = platformRect;
                    }
                }
            });
            
            // ç¬¬äºŒæ­¥ï¼šè™•ç†èˆ‡æœ€è¿‘å¹³å°çš„ç¢°æ’
            if (closestPlatform && closestDistance < player.jumpPower) {
                // ç©å®¶æ­£åœ¨ä¸‹è½ï¼Œä¸¦ä¸”è·é›¢å¹³å°å¾ˆè¿‘
                if (player.velocityY >= 0) {
                    player.y = closestPlatform.y - player.height;
                    player.velocityY = 0;
                    player.isJumping = false;
                    onPlatform = true;
                    
                    // æ‰¾åˆ°å°æ‡‰çš„å¹³å°æ•¸æ“š
                    const platformIndex = platforms.findIndex(p => 
                        p.x === closestPlatform.x && 
                        p.y + gameState.scrollY === closestPlatform.y
                    );
                    
                    if (platformIndex >= 0) {
                        const platform = platforms[platformIndex];
                        // æ”¶é›†ç¥ç¦è©
                        if (platform.blessing && !platform.collected) {
                            platform.collected = true;
                            gameState.collectedBlessings.push(platform.blessing);
                            gameState.score += 100;
                            showBlessingToast(platform.blessing);
                        }
                        
                        // åˆ°é”çµ‚é»
                        if (platform.blessing === 'çµ‚é»') {
                            gameState.won = true;
                            document.getElementById('winScreen').classList.add('visible');
                        }
                    }
                }
            }
            
            // å‚³çµ±ç¢°æ’æª¢æ¸¬ï¼ˆå‚™ç”¨ï¼‰
            if (!onPlatform) {
                platforms.forEach(platform => {
                    const platformRect = {
                        x: platform.x,
                        y: platform.y + gameState.scrollY,
                        width: platform.width,
                        height: platform.height
                    };
                    
                    const playerRect = {
                        x: player.x,
                        y: player.y,
                        width: player.width,
                        height: player.height
                    };
                    
                    // æ›´å¯¬é¬†çš„ç¢°æ’åˆ¤å®šæ¢ä»¶
                    if (player.velocityY >= 0 && 
                        playerRect.y + playerRect.height <= platformRect.y + 15 && // å¢åŠ åˆ¤å®šç¯„åœ
                        playerRect.y + playerRect.height + player.velocityY >= platformRect.y - 5 && // æå‰åˆ¤å®š
                        playerRect.x + playerRect.width > platformRect.x &&
                        playerRect.x < platformRect.x + platformRect.width) {
                        
                        player.y = platformRect.y - playerRect.height;
                        player.velocityY = 0;
                        player.isJumping = false;
                        onPlatform = true;
                        
                        // æ”¶é›†ç¥ç¦è©
                        if (platform.blessing && !platform.collected) {
                            platform.collected = true;
                            gameState.collectedBlessings.push(platform.blessing);
                            gameState.score += 100;
                            showBlessingToast(platform.blessing);
                        }
                        
                        // åˆ°é”çµ‚é»
                        if (platform.blessing === 'çµ‚é»') {
                            gameState.won = true;
                            document.getElementById('winScreen').classList.add('visible');
                        }
                    }
                });
            }
            
            player.isJumping = !onPlatform;
            
            // ç•«é¢æ»¾å‹• - å¹³ç©©æ»¾å‹•
            if (player.y < canvas.height / 3 && player.velocityY < 0) {
                gameState.scrollY -= player.velocityY * 0.8; // æ¸›ç·©æ»¾å‹•é€Ÿåº¦ï¼Œé¿å…å¹³å°ä½ç½®è·³å‹•
            }
            
            // æ‰è½æ‰£ç”Ÿå‘½
            if (player.y > canvas.height + 100) {
                gameState.lives--;
                if (gameState.lives <= 0) {
                    gameState.over = true;
                    document.getElementById('finalScore').textContent = `åˆ†æ•¸ï¼š${gameState.score}`;
                    document.getElementById('gameOverScreen').classList.add('visible');
                } else {
                    resetPlayer();
                }
            }
        }
        
        // é¡¯ç¤ºç¥ç¦è©æç¤º - å„ªåŒ–ç§»å‹•ç«¯é¡¯ç¤º
        function showBlessingToast(blessing) {
            const toast = document.createElement('div');
            toast.textContent = `æ”¶é›†åˆ°: ${blessing}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #ffd700;
                color: #8b0000;
                padding: 10px 20px;
                border-radius: 5px;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                font-size: ${isMobile ? '14px' : '16px'};
                max-width: 80%;
                text-align: center;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(toast);
                    document.head.removeChild(style);
                }, 300);
            }, 2000);
        }
        
        // ç¹ªè£½éŠæˆ² - å¹³å°ä½¿ç”¨é‡‘è‰²ç³»
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // èƒŒæ™¯
            if (gameAssets.background) {
                const pattern = ctx.createPattern(gameAssets.background, 'repeat');
                ctx.fillStyle = pattern;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = '#8b0000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // å¹³å° - ä½¿ç”¨é‡‘è‰²é…è‰²
            platforms.forEach(platform => {
                const drawY = platform.y + gameState.scrollY;
                
                if (drawY > -50 && drawY < canvas.height + 50) {
                    if (gameAssets.platform) {
                        ctx.drawImage(gameAssets.platform, platform.x, drawY, platform.width, platform.height);
                    } else {
                        // å‚™ç”¨ç¹ªè£½ - é‡‘è‰²ç³»
                        const gradient = ctx.createLinearGradient(0, drawY, 0, drawY + 20);
                        gradient.addColorStop(0, '#ffd700');
                        gradient.addColorStop(1, '#b8860b');
                        ctx.fillStyle = gradient;
                        ctx.fillRect(platform.x, drawY, platform.width, platform.height);
                        ctx.strokeStyle = '#8B7500';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(platform.x, drawY, platform.width, platform.height);
                    }
                    
                    // ç¥ç¦è©ï¼ˆçµ‚é»æ–‡å­—åŠ å¤§ï¼‰
                    if (platform.blessing && !platform.collected) {
                        ctx.fillStyle = '#8B0000'; // ç´…è‰²æ–‡å­—é…é‡‘è‰²å¹³å°æ›´é†’ç›®
                        const fontSize = platform.blessing === 'çµ‚é»' ? 'bold 34px Noto Sans TC' : 'bold 24px Noto Sans TC';
                        ctx.font = fontSize;
                        ctx.textAlign = 'center';
                        ctx.strokeStyle = '#ffd700';
                        ctx.lineWidth = 3;
                        ctx.strokeText(platform.blessing, platform.x + platform.width / 2, drawY - 10);
                        ctx.fillText(platform.blessing, platform.x + platform.width / 2, drawY - 10);
                    }
                }
            });
            
            // ç©å®¶
            if (gameAssets.player) {
                ctx.save();
                ctx.scale(player.direction, 1);
                const drawX = player.direction > 0 ? player.x : player.x + player.width;
                ctx.drawImage(
                    gameAssets.player, 
                    drawX * player.direction, 
                    player.y, 
                    player.width * player.direction, 
                    player.height
                );
                ctx.restore();
            } else {
                ctx.fillStyle = '#ff4500';
                ctx.fillRect(player.x, player.y, player.width, player.height);
            }
            
            // æ›´æ–°UI
            document.getElementById('scoreDisplay').textContent = `åˆ†æ•¸: ${gameState.score}`;
            document.getElementById('livesDisplay').textContent = `ç”Ÿå‘½: ${gameState.lives}`;
            
            // æ”¶é›†çš„ç¥ç¦è©
            ctx.fillStyle = '#ffd700';
            ctx.font = `bold ${isMobile ? '16px' : '18px'} Noto Sans TC`;
            ctx.textAlign = 'right';
            gameState.collectedBlessings.slice(-3).forEach((blessing, index) => {
                ctx.fillText(blessing, canvas.width - 20, 30 + index * (isMobile ? 22 : 25));
            });
        }
        
        // éŠæˆ²è¿´åœˆ - å„ªåŒ–ç§»å‹•ç«¯æ€§èƒ½
        let lastFrameTime = 0;
        const TARGET_FPS = 60;
        const FRAME_INTERVAL = 1000 / TARGET_FPS;
        
        function gameLoop(timestamp) {
            // æ§åˆ¶å¹€ç‡ï¼Œé¿å…ç§»å‹•ç«¯éè¼‰
            if (timestamp - lastFrameTime < FRAME_INTERVAL) {
                requestAnimationFrame(gameLoop);
                return;
            }
            
            lastFrameTime = timestamp;
            updatePlayer();
            drawGame();
            requestAnimationFrame(gameLoop);
        }
        
        // éµç›¤æ§åˆ¶
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                keys.left = true;
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                keys.right = true;
            }
            if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W' || e.key === ' ') {
                keys.up = true;
                // è·³èº
                if (!player.isJumping && gameState.started && !gameState.over && !gameState.won) {
                    player.velocityY = -player.jumpPower;
                    player.isJumping = true;
                }
            }
        });
        
        window.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                keys.left = false;
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                keys.right = false;
            }
            if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W' || e.key === ' ') {
                keys.up = false;
            }
        });
        
        // è§¦æ‘¸æ§åˆ¶äº‹ä»¶å¤„ç† - å„ªåŒ–ç§»å‹•ç«¯éŸ¿æ‡‰
        function setupTouchControls() {
            const touchLeft = document.getElementById('touchLeft');
            const touchRight = document.getElementById('touchRight');
            const touchJump = document.getElementById('touchJump');
            
            // å„ªåŒ–è§¸æ‘¸äº‹ä»¶è™•ç†ï¼Œé˜²æ­¢é‡è¤‡è§¸ç™¼
            function handleTouchStart(element, stateProp) {
                element.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    touchState[stateProp] = true;
                }, { passive: false });
                
                element.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    touchState[stateProp] = false;
                }, { passive: false });
                
                element.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    touchState[stateProp] = false;
                }, { passive: false });
                
                // æ·»åŠ é¼ æ¨™æ”¯æŒï¼Œæ–¹ä¾¿æ¸¬è©¦
                element.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    touchState[stateProp] = true;
                });
                
                element.addEventListener('mouseup', (e) => {
                    e.preventDefault();
                    touchState[stateProp] = false;
                });
                
                element.addEventListener('mouseleave', (e) => {
                    e.preventDefault();
                    touchState[stateProp] = false;
                });
            }
            
            // å·¦ç§»å‹•
            handleTouchStart(touchLeft, 'left');
            
            // å³ç§»å‹•
            handleTouchStart(touchRight, 'right');
            
            // è·³èºæŒ‰éˆ•å–®ç¨è™•ç†
            touchJump.addEventListener('touchstart', (e) => {
                e.preventDefault();
                e.stopPropagation();
                touchState.jump = true;
                // ç«‹å³è·³èº
                if (!player.isJumping && gameState.started && !gameState.over && !gameState.won) {
                    player.velocityY = -player.jumpPower;
                    player.isJumping = true;
                }
            }, { passive: false });
            
            touchJump.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                touchState.jump = false;
            }, { passive: false });
            
            touchJump.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                e.stopPropagation();
                touchState.jump = false;
            }, { passive: false });
            
            // é¼ æ¨™æ”¯æŒ
            touchJump.addEventListener('mousedown', (e) => {
                e.preventDefault();
                touchState.jump = true;
                if (!player.isJumping && gameState.started && !gameState.over && !gameState.won) {
                    player.velocityY = -player.jumpPower;
                    player.isJumping = true;
                }
            });
            
            touchJump.addEventListener('mouseup', (e) => {
                e.preventDefault();
                touchState.jump = false;
            });
            
            touchJump.addEventListener('mouseleave', (e) => {
                e.preventDefault();
                touchState.jump = false;
            });
            
            // é˜²æ­¢é¡µé¢æ»šåŠ¨å’Œç¼©æ”¾
            document.addEventListener('touchmove', (e) => {
                e.preventDefault();
            }, { passive: false });
            
            // é˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd < 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });
        }
        
        // æŒ‰éˆ•äº‹ä»¶
        document.getElementById('startBtn').addEventListener('click', () => {
            gameState.started = true;
            document.getElementById('startScreen').classList.remove('visible');
        });
        
        document.getElementById('restartBtn').addEventListener('click', resetGame);
        document.getElementById('playAgainBtn').addEventListener('click', resetGame);
        
        // åˆå§‹åŒ–è§¦æ‘¸æ§åˆ¶
        setupTouchControls();
        
        // åˆå§‹åŒ–éŠæˆ²
        loadGameAssets();
        initPlatforms();
        resetPlayer();
        gameLoop();
        
        // å¼·åˆ¶ç¹ªè£½ä¸€æ¬¡
        drawGame();
        
        console.log(`éŠæˆ²åˆå§‹åŒ–å®Œæˆï¼Œç§»å‹•ç«¯å„ªåŒ–ï¼š${isMobile ? 'å·²å•Ÿç”¨' : 'æœªå•Ÿç”¨'}`);
    </script>
</body>
</html>